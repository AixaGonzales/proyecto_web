<div class="search-filter-container">
    <!-- Área principal de búsqueda -->
    <div class="search-main-area">
        <!-- Campo de búsqueda -->
        <div class="search-field-wrapper">
            <div class="search-field" [class.has-filters]="hasActiveFilters()" [class.focused]="isSearchFocused">
                <mat-icon class="search-icon">search</mat-icon>
                
                <!-- INPUT CON PROTECCIÓN NUCLEAR -->
                <input 
                    type="text"
                    [(ngModel)]="searchTerm" 
                    (input)="handleSearch()" 
                    (focus)="onSearchFocus($event)"
                    (blur)="isSearchFocused = false" 
                    [placeholder]="placeholderText" 
                    class="search-input"
                    aria-label="Buscar"
                    autocomplete="off"
                    autocorrect="off"
                    autocapitalize="off"
                    spellcheck="false"
                    [name]="'search-' + randomId"
                    #searchInput
                    readonly
                    onfocus="this.removeAttribute('readonly');">

                <!-- Indicador de filtros activos -->
                @if (hasActiveFilters()) {
                <div class="active-filters-indicator">
                    <span class="filter-count">{{ getActiveFiltersCount() }}</span>
                </div>
                }

                <!-- Botón de limpiar búsqueda -->
                @if (searchTerm) {
                <button mat-icon-button class="clear-btn" (click)="removeSearchFilter()" matTooltip="Limpiar búsqueda">
                    <mat-icon>close</mat-icon>
                </button>
                }
            </div>
        </div>

        <!-- Botón de filtros avanzados -->
        @if (showFiltersButton && customFilters.length > 0) {
        <button class="filter-btn" [matMenuTriggerFor]="customFiltersMenu" [class.active]="hasActiveCustomFilters()"
            [class.has-filters]="hasActiveCustomFilters()" matTooltip="{{ customFiltersLabel }}"
            aria-label="{{ customFiltersLabel }}">
            <div class="filter-btn-content">
                <mat-icon class="filter-icon">tune</mat-icon>
                <span class="filter-label">{{ customFiltersLabel }}</span>
                @if (hasActiveCustomFilters()) {
                <div class="active-dot"></div>
                }
            </div>
        </button>
        }
    </div>
</div>

<!-- Menú de filtros personalizados -->
<mat-menu #customFiltersMenu="matMenu" class="custom-filters-menu" xPosition="before" (closed)="onFiltersMenuClosed()">

    <!-- Header del menú -->
    <div class="filter-menu-header">
        <div class="header-content">
            <div class="header-icon-wrapper">
                <mat-icon class="header-icon">filter_alt</mat-icon>
            </div>
            <div class="header-text">
                <h3>{{ customFiltersLabel }}</h3>
                <p class="filter-subtitle">Aplica filtros específicos para refinar tu búsqueda</p>
            </div>
        </div>

        @if (hasActiveCustomFilters()) {
        <button class="header-clear-btn" (click)="clearAllCustomFilters(); $event.stopPropagation()"
            matTooltip="Limpiar todos los filtros">
            <mat-icon>refresh</mat-icon>
            <span>Limpiar</span>
        </button>
        }
    </div>

    <!-- Contenedor de filtros -->
    <div class="filters-container" [class.has-scroll]="hasScroll" (scroll)="onFiltersContainerScroll($event)">
        @for (filter of customFilters; track filter.key) {
        <div class="custom-filter-item" [class.active]="getFilterDisplayValue(filter)">
            <div class="filter-header">
                <label class="filter-label">
                    <mat-icon class="filter-type-icon">
                        {{ getFilterTypeIcon(filter.type) }}
                    </mat-icon>
                    {{ filter.label }}
                </label>
                @if (getFilterDisplayValue(filter)) {
                <button class="clear-filter-btn" (click)="removeCustomFilter(filter.key); $event.stopPropagation()"
                    matTooltip="Limpiar filtro">
                    <mat-icon>close</mat-icon>
                </button>
                }
            </div>

            <!-- Select para opciones -->
            @if (filter.type === 'select' && filter.options) {
            <div class="select-wrapper">
                <select 
                    [(ngModel)]="filter.value" 
                    (change)="onCustomFilterChange(filter.key, filter.value)"
                    class="filter-select" 
                    [name]="'select-' + filter.key"
                    autocomplete="off">
                    <option [value]="null">Todos</option>
                    @for (option of filter.options; track option.value) {
                    @if (option.value !== null) {
                    <option [value]="option.value">
                        {{ option.label }}
                    </option>
                    }
                    }
                </select>
                <mat-icon class="select-arrow">arrow_drop_down</mat-icon>
            </div>
            }

            <!-- Input de texto -->
            @if (filter.type === 'text') {
            <div class="input-wrapper">
                <input 
                    type="text" 
                    [(ngModel)]="filter.value" 
                    (input)="onCustomFilterChange(filter.key, filter.value)"
                    [placeholder]="filter.placeholder || 'Filtrar por ' + filter.label" 
                    class="filter-input"
                    autocomplete="off" 
                    autocorrect="off" 
                    autocapitalize="off" 
                    spellcheck="false"
                    [name]="'text-' + filter.key">
                @if (filter.value) {
                <button class="input-clear" (click)="filter.value = ''; onCustomFilterChange(filter.key, '')">
                    <mat-icon>close</mat-icon>
                </button>
                }
            </div>
            }

            <!-- Input numérico -->
            @if (filter.type === 'number') {
            <div class="input-wrapper">
                <input 
                    type="number" 
                    [(ngModel)]="filter.value" 
                    (input)="onCustomFilterChange(filter.key, filter.value)"
                    [placeholder]="filter.placeholder || filter.label" 
                    class="filter-input" 
                    autocomplete="off"
                    [name]="'number-' + filter.key">
                @if (filter.value) {
                <button class="input-clear" (click)="filter.value = null; onCustomFilterChange(filter.key, null)">
                    <mat-icon>close</mat-icon>
                </button>
                }
            </div>
            }

            <!-- Rango de números -->
            @if (filter.type === 'range') {
            <div class="range-inputs">
                <div class="range-input-group">
                    <label class="range-label">Mínimo</label>
                    <input 
                        type="number" 
                        [(ngModel)]="filter.value.min"
                        (input)="onCustomFilterChange(filter.key, filter.value)"
                        [placeholder]="'Mín ' + (filter.placeholder || '')" 
                        class="filter-input range-min"
                        autocomplete="off" 
                        name="range-min">
                </div>
                <div class="range-separator">
                    <mat-icon>remove</mat-icon>
                </div>
                <div class="range-input-group">
                    <label class="range-label">Máximo</label>
                    <input 
                        type="number" 
                        [(ngModel)]="filter.value.max"
                        (input)="onCustomFilterChange(filter.key, filter.value)"
                        [placeholder]="'Máx ' + (filter.placeholder || '')" 
                        class="filter-input range-max"
                        autocomplete="off" 
                        name="range-max">
                </div>
            </div>
            }
        </div>
        }
    </div>

    <!-- Footer del menú -->
    <div class="filter-footer">
        <div class="results-info">
            <mat-icon>info</mat-icon>
            <span>{{ getActiveFiltersCount() }} filtro(s) activo(s)</span>
        </div>
    </div>
</mat-menu>